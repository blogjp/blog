---
layout: post
title: 小内存VPS记录 Debian 6 32bit
tags: ['Nginx', 'VPS']
description: debian 6 32bit 安装 nginx 及 php + MySQL记录
---
探针:<a href="http://vps.kooker.jp/tz.php" target="_blank">http://vps.kooker.jp/tz.php</a> 

Demo: <a href="http://vps.kooker.me" target="_blank">http://vps.kooker.me</a> 

<a href="http://old-blog.kooker.jp/tag/debian/" onclick="javascript:tagshow('debian');return false;">debian</a> 6 32bit 安装 <a href="http://old-blog.kooker.jp/tag/nginx/" onclick="javascript:tagshow('nginx');return false;">nginx</a> 及 php + MySQL记录

升级系统：
<pre class="brush:bash;">apt-get update&amp;&amp;apt-get upgrade
</pre>
多余的软件
<pre class="brush:bash;">apt-get -y purge apache2-* bind9-* xinetd samba-* nscd-* portmap sendmail-* sasl2-bin
</pre>
多余的系统组件
<pre class="brush:bash;">apt-get -y purge lynx memtester unixodbc python-* odbcinst-* sudo tcpdump ttf-*</pre>
最后清理一下：
<pre class="brush:bash;">apt-get autoremove &amp;&amp; apt-get clean</pre>
安装必要的一些组件：
<pre class="brush:bash;">apt-get install automake wget zip unzip make time</pre>
使用postfix 替代Sendmail
<pre class="brush:bash;">apt-get install postfix</pre>
For Debian 6 append the following contents to /etc/apt/sources.list:
<pre class="brush:bash;">deb http://nginx.org/packages/debian/ squeeze nginx
deb-src http://nginx.org/packages/debian/ squeeze nginx
</pre>
Then run the following commands:<br />
<pre class="brush:bash;">apt-get update
apt-get -f install
apt-get install nginx</pre>
安装mysql5.1,安装过程会需要你输入root密码
<pre class="brush:bash;">apt-get install mysql-server-5.1
/etc/init.d/mysql restart
/etc/init.d/mysql stop</pre>
PHP5 /etc/apt/sources.list:
<pre class="brush:bash;">deb http://packages.dotdeb.org stable all
deb-src http://packages.dotdeb.org stable all
deb http://php53.dotdeb.org stable all
deb-src http://php53.dotdeb.org stable all</pre>
安装PHP
<pre class="brush:bash;">apt-get install php5-cli php5-common php5-suhosin php5-mcrypt php-doc php5-odbc php5-memcache php5-xmlrpc php5-xsl php5-json php-apc php5-dev
apt-get install php5-fpm php5-cgi</pre>
重启nginx服务器
<pre class="brush:bash;">/etc/init.d/nginx restart</pre>
配置完成php.ini后需要重启php5-fpm
<pre class="brush:bash;">/etc/init.d/php5-fpm restart</pre>
/etc/nginx/conf.d/default.conf
<pre class="brush:bash;"> server {
    listen   80;
    server_name  localhost;
    access_log  /var/log/nginx/localhost.access.log;
 
## Default location
    location / {
        root   /var/www;
        index  index.php;
    }
 
## Images and static content is treated different
    location ~* ^.+.(jpg|jpeg|gif|css|png|js|ico|xml)$ {
      access_log        off;
      expires           30d;
      root /var/www;
    }
 
## Parse all .php file in the /var/www directory
    location ~ .php$ {
        fastcgi_split_path_info ^(.+\.php)(.*)$;
        fastcgi_pass   backend;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  /var/www$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_param  QUERY_STRING     $query_string;
        fastcgi_param  REQUEST_METHOD   $request_method;
        fastcgi_param  CONTENT_TYPE     $content_type;
        fastcgi_param  CONTENT_LENGTH   $content_length;
        fastcgi_intercept_errors        on;
        fastcgi_ignore_client_abort     off;
        fastcgi_connect_timeout 60;
        fastcgi_send_timeout 180;
        fastcgi_read_timeout 180;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
    }
 
## Disable viewing .htaccess &amp; .htpassword
    location ~ /\.ht {
        deny  all;
    }
}
upstream backend {
        server 127.0.0.1:9000;
}

</pre>
<h3>Nginx使用webbench进行压力测试</h3>
一、安装webbench<br />
webbench是Linux下的一个网站压力测试工具，最多可以模拟3万个并发连接去测试网站的负载能力。

<pre class="brush:bash;">wget http://home.tiscali.cz/~cz210552/distfiles/webbench-1.5.tar.gz
tar zxvf webbench-1.5.tar.gz
cd webbench-1.5
make &amp;&amp; make install</pre>

二、webbench使用

webbench -?    (查看命令帮助)

参数解释：-c为并发数，-t为时间(秒)

测试实例：
<pre class="brush:bash;">webbench -c 50 -t 60 http://vps.kooker.jp/index.php</pre>
webbench测试结果
<pre class="brush:bash;">Webbench - Simple Web Benchmark 1.5
Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.

Benchmarking: GET http://vps.kooker.jp/index.php
50 clients, running 60 sec.

Speed=3375 pages/min, 620559 bytes/sec.
Requests: 3375 susceed, 0 failed.</pre>
分析：每秒钟响应请求数 3375 pages/min, 每秒钟传输数据量 620559 bytes/sec.
<pre class="brush:bash;">Webbench - Simple Web Benchmark 1.5
Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.

Benchmarking: GET http://vps.kooker.jp/index.php
100 clients, running 60 sec.

Speed=3122 pages/min, 574187 bytes/sec.
Requests: 3122 susceed, 0 failed.
</pre>
当并发100时，速度开始变慢
<pre class="brush:bash;">Webbench - Simple Web Benchmark 1.5
Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.

Benchmarking: GET http://vps.kooker.jp/index.php
200 clients, running 60 sec.

Speed=8678 pages/min, 430486 bytes/sec.
Requests: 4906 susceed, 3772 failed.
</pre>
当并发200时，由此可见Nginx服务器已无法再处理用户访问请求

Google 随机IP
{%highlight php%}
<?php header('Content-Type: text/html; charset=utf-8');error_reporting(0);
$google_ip_array=array('203.208.46.131','203.208.46.132','203.208.46.133','203.208.46.134','203.208.46.135','203.208.46.136','203.208.46.137','203.208.46.138');
$rand_ip=($google_ip_array[rand(0,7)]);
header("Location: http://$rand_ip");
exit;
?>
{%endhighlight%}
<script type="text/javascript" src="http://sablogbae.cdn.duapp.com/include/syntax/scripts/shCore.js"></script><script type="text/javascript" src="http://sablogbae.cdn.duapp.com/include/syntax/scripts/shLegacy.js"></script> <script type="text/javascript" src="http://sablogbae.cdn.duapp.com/include/syntax/scripts/shBrushAll.js"></script><link type="text/css" rel="stylesheet" href="http://sablogbae.cdn.duapp.com/include/syntax/styles/shCore.css"/><link type="text/css" rel="stylesheet" href="http://sablogbae.cdn.duapp.com/include/syntax/styles/shThemeDefault.css"/><script type="text/javascript">SyntaxHighlighter.config.clipboardSwf='http://sablogbae.cdn.duapp.com/include/syntax/scripts/clipboard.swf';SyntaxHighlighter.all();dp.SyntaxHighlighter.HighlightAll('code');</script>